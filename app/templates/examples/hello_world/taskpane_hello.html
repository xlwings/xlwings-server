{% extends "base.html" %}

{% block content %}
  <div class="container-fluid pt-3 ps-3">
    <h1>Example Task Pane</h1>
    <div class="mb-3 d-flex flex-column gap-2">
      <button xw-click="hello_world" xw-config='{"exclude": "MySheet"}' class="btn btn-primary btn-sm" type="button">
        Write 'Hello/Bye xlwings!' to A1
      </button>
      <button
        xw-click="setup_custom_functions"
        xw-config='{"exclude": "MySheet"}'
        class="btn btn-primary btn-sm"
        type="button">
        Insert sheet with custom functions
      </button>
      {% if not settings.enable_lite %}
        <button xw-click="show_alert" xw-config='{"exclude": "MySheet"}' class="btn btn-primary btn-sm" type="button">
          Show an alert
        </button>
      {% endif %}
      <button xw-click="show_plot" xw-config='{"exclude": "MySheet"}' class="btn btn-primary btn-sm" type="button">
        Insert a Matplotlib Plot
      </button>
      <button xw-click="show_error" xw-config='{"exclude": "MySheet"}' class="btn btn-primary btn-sm" type="button">
        Show an error message
      </button>
    </div>
  </div>
  <script type="text/javascript">
    async function main() {
      let pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      await micropip.install(["xlwings", "python-dotenv", "pandas"]);
      return pyodide;
    }
    let pyodideReadyPromise = main();

    async function evaluatePython() {
      let pyodide = await pyodideReadyPromise;
      try {
        // Fetch both Python files
        const mainResponse = await fetch("/lite/main2.py");
        const configResponse = await fetch("/lite/config.py");
        const examplesResponse = await fetch("/custom_functions/examples.py");

        // Get text content
        const configText = await configResponse.text();
        const mainText = await mainResponse.text();
        const examplesText = await examplesResponse.text();

        // Write config.py to virtual filesystem
        pyodide.FS.writeFile("./config.py", configText);
        pyodide.FS.mkdir("./custom_functions");
        pyodide.FS.mount(pyodide.FS.filesystems.MEMFS, {}, "./custom_functions");
        pyodide.FS.writeFile("./custom_functions/examples.py", examplesText);

        // Run main2.py which can now import config
        await pyodide.runPythonAsync(mainText);

        const hello = pyodide.globals.get("hello");
        const result = hello();
        console.log(result);
      } catch (err) {
        console.log(err);
      }
    }
    evaluatePython();
  </script>
{% endblock content %}

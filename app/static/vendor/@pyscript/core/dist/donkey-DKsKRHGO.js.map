{"version":3,"file":"donkey-DKsKRHGO.js","sources":["../node_modules/add-promise-listener/index.js","../src/plugins/donkey.js"],"sourcesContent":["const { defineProperty } = Object;\nconst { get } = Reflect;\n\nconst methods = [\n  'preventDefault',\n  'stopPropagation',\n  'stopImmediatePropagation',\n];\n\nconst once = { once: true };\n\n// avoid event.preventDefault throwing due illegal Proxy invocation\nconst bound = (e, value) => typeof value === 'function' ? value.bind(e) : value;\n\n// traps the `event.currentTarget` to be sure it's available later on\nclass Handler {\n  #currentTarget;\n  constructor(currentTarget) {\n    this.#currentTarget = currentTarget;\n  }\n  get(e, name) {\n    // Did you know? event.currentTarget disappears from events on\n    // next tick, which is why this proxy handler needs to exist.\n    return name === 'currentTarget' ? this.#currentTarget : bound(e, get(e, name));\n  }\n}\n\n/**\n * Add a listener that result as a Promise, fulfilled when the event happens once or rejected if the optional provided signal is aborted.\n * @param {Element} element\n * @param {string} type\n * @param {{ signal?:AbortSignal, capture?:boolean, passive?:boolean, preventDefault?:boolean, stopPropagation?:boolean, stopImmediatePropagation?:boolean }?} options\n * @returns {Promise<Event,Event>}\n */\nexport default (element, type, options = null) => new Promise(\n  (resolve, reject) => {\n    const handler = new Handler(element);\n    if (options.signal) {\n      const abort = event => reject(new Proxy(event, handler));\n      options.signal.addEventListener('abort', abort, once);\n      if (options.signal.aborted)\n        return options.signal.dispatchEvent(new Event('abort'));\n    }\n    element.addEventListener(\n      type,\n      (event) => {\n        for (const method of methods) {\n          if (options[method]) event[method]();\n        }\n        resolve(new Proxy(event, handler));\n      },\n      { ...options, ...once }\n    );\n  }\n);\n","import addPromiseListener from \"add-promise-listener\";\nimport { assign, dedent } from \"polyscript/exports\";\n\nconst { stringify } = JSON;\n\nconst invoke = (name, args) => `${name}(code, ${args.join(\", \")})`;\n\nconst donkey = ({ type = \"py\", persistent, terminal, config }) => {\n    const globals = terminal ? '{\"__terminal__\":__terminal__}' : \"{}\";\n    const args = persistent ? [\"globals()\", \"__locals__\"] : [globals, \"{}\"];\n\n    const src = URL.createObjectURL(\n        new Blob([\n            [\n                // this array is to better minify this code once in production\n                \"from pyscript import sync, config\",\n                '__message__ = lambda e,v: f\"\\x1b[31m\\x1b[1m{e.__name__}\\x1b[0m: {v}\"',\n                \"__locals__ = {}\",\n                'if config[\"type\"] == \"py\":',\n                \"\timport sys\",\n                \"\tdef __error__(_):\",\n                \"\t\tinfo = sys.exc_info()\",\n                \"\t\treturn __message__(info[0], info[1])\",\n                \"else:\",\n                \"\t__error__ = lambda e: __message__(e.__class__, e.value)\",\n                \"def execute(code):\",\n                `\ttry: return ${invoke(\"exec\", args)};`,\n                \"\texcept Exception as e: print(__error__(e));\",\n                \"def evaluate(code):\",\n                `\ttry: return ${invoke(\"eval\", args)};`,\n                \"\texcept Exception as e: print(__error__(e));\",\n                \"sync.execute = execute\",\n                \"sync.evaluate = evaluate\",\n            ].join(\"\\n\"),\n        ]),\n    );\n\n    // create the script that exposes the code to execute or evaluate\n    const script = assign(document.createElement(\"script\"), { type, src });\n    script.toggleAttribute(\"worker\", true);\n    script.toggleAttribute(\"terminal\", true);\n    if (terminal) script.setAttribute(\"target\", terminal);\n    if (config) {\n        script.setAttribute(\n            \"config\",\n            typeof config === \"string\" ? config : stringify(config),\n        );\n    }\n\n    return addPromiseListener(\n        document.body.appendChild(script),\n        `${type}:done`,\n        { stopPropagation: true },\n    ).then(() => {\n        URL.revokeObjectURL(src);\n        return script;\n    });\n};\n\nconst utils = async (options) => {\n    const script = await donkey(options);\n    const { xworker, process, terminal } = script;\n    const { execute, evaluate } = xworker.sync;\n    script.remove();\n    return {\n        xworker,\n        process,\n        terminal,\n        execute,\n        evaluate,\n    };\n};\n\nexport default async (options = {}) => {\n    let farmer = await utils(options);\n    let working = false;\n    const kill = () => {\n        if (farmer) {\n            farmer.xworker.terminate();\n            farmer.terminal.dispose();\n            farmer = null;\n        }\n        working = false;\n    };\n    const reload = async () => {\n        kill();\n        farmer = await utils(options);\n    };\n    const asyncTask = (method) => async (code) => {\n        // race condition ... a new task has been\n        // assigned while the previous one didn't finish\n        if (working) await reload();\n        working = true;\n        try {\n            return await farmer[method](dedent(code));\n        } catch (e) {\n            console.error(e);\n        } finally {\n            working = false;\n        }\n    };\n    const asyncMethod = (method) => async () => {\n        if (working) await reload();\n        else farmer?.terminal[method]();\n    };\n    return {\n        process: asyncTask(\"process\"),\n        execute: asyncTask(\"execute\"),\n        evaluate: asyncTask(\"evaluate\"),\n        clear: asyncMethod(\"clear\"),\n        reset: asyncMethod(\"reset\"),\n        kill,\n    };\n};\n"],"names":["get","Reflect","methods","once","Handler","currentTarget","constructor","this","e","name","value","bind","bound","stringify","JSON","invoke","args","join","donkey","type","persistent","terminal","config","src","URL","createObjectURL","Blob","script","assign","document","createElement","toggleAttribute","setAttribute","element","options","Promise","resolve","reject","handler","signal","abort","event","Proxy","addEventListener","aborted","dispatchEvent","Event","method","addPromiseListener","body","appendChild","stopPropagation","then","revokeObjectURL","utils","async","xworker","process","execute","evaluate","sync","remove","donkey$1","farmer","working","kill","terminate","dispose","reload","asyncTask","code","dedent","console","error","asyncMethod","clear","reset"],"mappings":"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","x_google_ignoreList":[0]}